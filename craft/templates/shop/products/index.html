{% extends 'shop/_layouts/main' %}

{% import "shop/macros/product.html" as prodmac %}

{% set params = {with: ['productImages']} %}
{% set formParams = {'productParam' : ''} %}
{% set categoriesArray = ['or'] %}

{% if craft.request.getPost() %}
 {% set formResults = craft.request.getPost() %}
 {% set formParams = formParams|merge(formResults) %}
 {% for postVarName,postVarValue in formResults  %}
     {% switch postVarName %}
     {% case "sale" %}
     {% set params = params|merge({hasSales : true}) %}
     {% case "sativa" or "indica" or "hybrid" %}
     {% set category = craft.categories.slug(postVarName).ids() %}
     {% set categoriesArray = categoriesArray|merge([{targetElement: category,}]) %}
     {% set params = params|merge({relatedTo : categoriesArray}) %}
     {% case "oil" %}
     {% set params = params|merge({type : 'Oil'}) %}
     {% case "flower" %}
     {% set params = params|merge({type : 'Flower'}) %}
     {% case "edibles" %}
     {% set params = params|merge({type : 'Edibles'}) %}
     {% case "stock" %}
     {% set params = params|merge({hasVariant:{hasStock : true}}) %}
     {% case "sortBy" %}
     {% if postVarValue == "new" %}
         {% set params = params|merge({order : 'postDate DESC'}) %}
     {% elseif postVarValue == "htl" %}
         {% set params = params|merge({order : 'defaultPrice DESC'}) %}
     {% elseif postVarValue == "lth" %}
         {% set params = params|merge({order : 'defaultPrice ASC'}) %}
     {% elseif postVarValue == "reviewHtl" %}
         {% set params = params|merge({order : 'averageRating DESC'}) %}
     {% endif %}
     {% endswitch %}
 {% endfor %}
{% endif %}
{% if craft.request.getParam('cat') is not null %}
    {% set productParam = craft.request.getParam('cat') %}
    {% set formParams = {'productParam' : productParam} %}
    {% switch productParam %}
    {% case "sale" %}
    {% set params = params|merge({hasSales : true}) %}
    {% case "sativa" or "indica" or "hybrid" %}
    {% set category = craft.categories.slug(productParam).ids() %}
    {% set categoriesArray = categoriesArray|merge([{targetElement: category,}]) %}
    {% set params = params|merge({relatedTo : categoriesArray}) %}
    {% case "organic" %}
    {% set params = params|merge({'organic' : true}) %}
    {% case "oil" %}
    {% set params = params|merge({type : 'Oil'}) %}
    {% case "Edibles" %}
    {% set params = params|merge({type : 'Edibles'}) %}
    {% endswitch %}
{% endif %}
{% set products = craft.commerce.products(params) %}
{% set hashVal =  craft.thcpost.hashValue(formParams) %}

{% block main %}
    <section class="shop product-listings product-listing-app content-section">
        <div class="wrapper container-fluid">
                    <h1>Shop</h1>
                    <div class="product-filters-wrapper row center-xs">
                        <div class="col-xs-12 col-sm-8 col-md-6">
                            {% cache  globally using key "productsform-" ~ craft.request.path ~ '-' ~ hashVal %}
                                {% minify %}
                                    {{ params is defined and params ? prodmac.productForm(formParams) }}
                                {% endminify %}
                            {% endcache %}
                        </div>
                    </div>
                    <div class="products-list has-text-centered row">
                        {% set imageSetting = { width: 460, ratio: 1 , jpegQuality: 85} %}
                        {% cache  globally using key "products-" ~ craft.request.path ~ '-' ~ hashVal %}
                            {% minify %}
                                {% for product in products %}
                                    {% include '/shop/_includes/product/_productCard.html' %}
                                {% endfor %}
                            {% endminify %}
                        {% endcache %}
            </div>
        </div>
    </section>
{% endblock %}
{% block scripts %}
    {% cache  globally using key "productsjs-" ~ craft.request.path ~ '-' ~ hashVal %}
     {% minify js %}
     <script type="text/javascript">
         var dataProducts = {
             formShop :{
                 sativa: {{ formParams['sativa'] is defined or formParams['productParam'] == 'sativa' ? 'true' : 'false' }},
                 indica: {{ formParams['indica'] is defined or formParams['productParam'] == 'indica' ? 'true' : 'false' }},
                 hybrid: {{ formParams['hybrid'] is defined or formParams['productParam'] == 'hybrid' ? 'true' : 'false' }},
                 oil: {{ formParams['oil'] is defined or formParams['productParam'] == 'concentrates' ? 'true' : 'false' }},
                 stock: {{ formParams['stock'] is defined ? 'true' : 'false' }},
                 sale: {{ formParams['sale'] is defined or formParams['productParam'] == 'sale' ? 'true' : 'false' }},
                 sortBy: '{{ formParams['sortBy'] is defined ?  formParams['sortBy']  : 'new' }}',
             },
             filtersExposed: false,
             formToggleIcon: 'icon-plus-1',
             formState: 'product-filters-form--closed'
         };
         var methodsProducts = {
             toggleFilters: function() {
                 this.filtersExposed = !this.filtersExposed;
                 this.filtersExposed ? this.formToggleIcon = "icon-minus" : this.formToggleIcon = "icon-plus-1";
                 this.filtersExposed ? this.formState = "product-filters-form--open" : this.formState = "product-filters-form--closed";
             },
         };

         thcpost.vueParams.data = Object.assign(thcpost.vueParams.data, dataProducts);
         thcpost.vueParams.methods = Object.assign(thcpost.vueParams.methods, methodsProducts);
     </script>
     {% endminify %}
    {% endcache %}
 {% endblock %}