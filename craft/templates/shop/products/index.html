{% extends 'shop/_layouts/main' %}
{% block main %}
{% set params = [] %}
{% if craft.request.getParam('cat') is not null %}
    {% set productParam = craft.request.getParam('cat') %}
    {% set params = params|merge([{'productParam' : productParam}]) %}
    {% set categoriesArray = ['and'] %}
    {% switch productParam %}
        {% case "sale" %}
            {% set products = craft.commerce.products.hasSales(true).limit(10).find() %}
        {% case "sativa" or "indica" or "hybrid" %}
            {% set category = craft.categories.slug(productParam).ids() %}
            {% set categoriesArray = categoriesArray|merge([{
                    targetElement: category,
            }]) %}
            {% set products = craft.commerce.products({
                    relatedTo: categoriesArray,
                    with: ['productImages']
                })

            %}
        {% case "organic" %}
            {% set products = craft.commerce.products.limit(10).find() %}
        {% case "concentrates" %}
            {% set products = craft.commerce.products.type('Oil').limit(10).find() %}
        {% default %}
            {% set products = craft.commerce.products.limit(10).find() %}
    {% endswitch %}
    {#{% set products = craft.commerce.products(params) %}#}
    {% else %}
            {% set products = craft.commerce.products.limit(10).find() %}
{% endif %}

{% macro productForm(params) %}
{% if params %}
    <form id="product-filters-form" action="{{ url('shop/') }}" method="get">
    </form>
{% endif %}
{% endmacro %}
{% from _self import productForm %}
<section class="shop product-listings u-bg-pink-pastelle">
    <div class="wrapper container-fluid">
        <div class="row">
            <div class="col-xs-12">
                <h1>Shop</h1>
                <div class="product-filters-wrapper">
                    {{ params is defined and params ? productForm(params) }}
                </div>
                <div class="products-list row">
                    {% for product in products %}
                        <a id="product_card_{{loop.index}}" class="product-card product-card--{{ product.strainType.first().slug }} product-card--{{ product.type }} col-xs-12 col-sm-6 col-md-4 col-lg-3" href="{{ product.url }}">
                        {% set image = product.productImages[0] ?? null  %}
                            {% if image %}
                                <picture class="full-width">
                                    <img class="product-cat__image"
                                         src="{{image.url}}"
                                         sizes="100vw"
                                         srcset=""
                                         alt="{{image.title}}">
                                </picture>
                            {% endif %}
                            <div class="product-card__overlay">
                            {% if product.defaultVariant.onSale %}
                                <div class="product-card__ribbon product-card__ribbon--sale">
                                    <span>Sale</span>
                                </div>
                            {% endif %}
                            <div class="product-card__information">
                                <h3 class="product-title">{{ product.title }}</h3>
                                <div class="product-price-wrapper">
                                    {% if product.defaultVariant.onSale %}
                                       <span class="sale-price">was  <strike>{{ product.defaultVariant.price|commerceCurrency(cart.currency) }}</strike></span>
                                    {% endif %}
                                    <span class="price">{{  product.defaultVariant.salePrice|commerceCurrency(cart.currency) }}</span>
                                </div>
                            </div>
                            {%  if product.totalStock < 1 %}
                                <div class="product-card__ribbon product-card__ribbon--out-of-stock">
                                    <span>Out of Stock</span>
                                </div>
                            {% endif %}
                            </div>
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}