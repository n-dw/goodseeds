{% extends "_layouts/cp" %}

{% includeCssResource 'comments/css/comments.css' %}
{% includeJsResource 'comments/js/comments.js' %}


{% macro starRating(rating, starcount) %}
    {% set hasHalfStar = (rating % 2 != 0) %}
    {% set starAmount = (rating / 2) |round(0, 'floor') %}
    {% set emptyStarAmount = starcount|default(5) - starAmount  %}
    {% if hasHalfStar %}
        {% set emptyStarAmount = emptyStarAmount - 1 %}
    {% endif %}
    <div class="product__star-rating">
        {% for i in 0..starAmount - 1  %}
            <i class="icon-star"></i>
        {% endfor %}
        {% if hasHalfStar %}
            <i class="icon-star-half"></i>
        {% endif %}
        {% if emptyStarAmount > 0 %}
            {% for i in 0..emptyStarAmount - 1  %}
                <i class="icon-star-empty"></i>
            {% endfor %}
        {% endif %}
    </div>

{% endmacro %}
{% from _self import starRating %}

{% import "_includes/forms" as forms %}

{% set title = 'Edit Comment' %}
{% set fullPageForm = true %}

{% set crumbs = [
    { label: "Comments" | t, url: url('comments') },
    { label: "Edit" | t, url: url('comments/edit/'~ comment.id ) }
] %}

{% set replies = craft.comments.all({ 'descendantOf': comment.id, limit: null }) %}
{% set elementType = craft.elements.getElementType('Comments_Comment') %}

{% set repliesElementAttr = {
    elementType: elementType,
    disabledElementIds: null,
    attributes: {
        id: ['id', { label: 'Comment' }],
        dateCreated: ['dateCreated', { label: 'Date' }],
    },
    elements: replies,
    showCheckboxes: false,
    structureEditable: false,
} %}

{% set extraPageHeaderHtml %}
    <div class="buttons right">
        <input type="submit" class="btn submit" value="{{ 'Save comment' | t }}">
    </div>
{% endset %}

{% block main %}
    <input type="hidden" name="action" value="comments/saveComment">
    <input type="hidden" name="redirect" value="comments/edit/{{ comment.id }}">
    <input type="hidden" name="commentId" value="{{ comment.id }}">

    <div class="grid first">
        <div class="item" data-position="left" data-colspan="2">
            <div class="pane">
                <div id="comment">
                    {{ forms.textAreaField({
                        first: true,
                        label: "Comment" | t,
                        id: 'comment',
                        name: 'comment',
                        rows: '10',
                        value: (comment is defined ? comment.comment : null),
                        errors: (comment is defined ? comment.getErrors('comment') : null),
                    }) }}

                    <hr/>


                    <div id="ratings" class="">
                        <h2>Comment Rating</h2>
                        {% set rating = craft.commentsrating.commentRating(comment.id) %}
                        <p>Rating out of 10:  <b>{{ rating }}</b></p>
                        {# {% if comment.canEdit() %}
                            <form class="edit-comment-form" id="comment_edit_form_{{ comment.id }}" role="form" method="post">
                                <input type="hidden" name="action" value="comments/edit">
                               #}{# <input type="hidden" name="elementId" value="{{ element.id }}">#}{#
                                <input type="hidden" name="commentId" value="{{ comment.id }}">

                                #}{# Anti-spam and security measures #}{#
                                {{ craft.comments.protect() }}
                                {{ getCsrfInput() }}

                                <div class="input-wrapper c-fieldset">
                                    <label for="rate_product">Rating *</label>
                                    <div class="field-control">
                                        <select id="rate_product" class="c-input-option u-max-width--input" name="fields[commentsRating]">
                                            <option value="2" {% if rating == 2 %}{{ 'selected' }}{% endif %}>1</option>
                                            <option value="3" {% if rating == 3 %}{{ 'selected' }}{% endif %}>1.5</option>
                                            <option value="4" {% if rating == 4 %}{{ 'selected' }}{% endif %}>2</option>
                                            <option value="5" {% if rating == 5 %}{{ 'selected' }}{% endif %}>2.5</option>
                                            <option value="6" {% if rating == 6 %}{{ 'selected' }}{% endif %}>3</option>
                                            <option value="7" {% if rating == 7 %}{{ 'selected' }}{% endif %}>3.5</option>
                                            <option value="8" {% if rating == 8 %}{{ 'selected' }}{% endif %}>4</option>
                                            <option value="9" {% if rating == 9 %}{{ 'selected' }}{% endif %}>4.5</option>
                                            <option value="10" {% if rating == 10 %}{{ 'selected' }}{% endif %}>5</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="input-wrapper c-fieldset">
                                    <button type="submit" class="c-button c-button--cta-black c-button--small">Save Review</button>
                                </div>

                            </form>
                        {% endif %}#}
                    </div>
                    <hr/>
                    <div id="items" class="">
                        <h2>Replies</h2>

                        {% if comment.hasDescendants %}
                            <div class="elementindex">
                                {% include "_elements/tableview/container" with repliesElementAttr %}
                            </div>
                        {% else %}
                            <p><em>No replies for this comment</em></p>
                        {% endif %}

                    </div>
                </div>
            </div>
        </div>

        <div class="item" data-position="right" data-colspan="1">
            <div class="pane">

                <h5>{{ "Status" | t }}</h5>
                <input type="hidden" name="status" value="{{ comment.status }}" />

                <div class="btn menubtn statusmenubtn">
                    <span class="status {{ comment.status }}"></span>{{ comment.status | capitalize }}
                </div>

                <div class="menu status-settings">
                    <ul class="padded">
                        {% for status, label in elementType.getStatuses() %}
                            <li>
                                <a data-status="{{ status }}" {{ (status == comment.status) ? 'class="sel"' : '' }}>
                                    <span class="status {{ status }}"></span>{{ label }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                <hr/>

                <h5 class="first">{{ "User" | t }}</h5>
                {% if comment.userId and craft.users %}
                    {% set user = craft.users.id(comment.userId).first() %}
                    <p><a class="go" href="{{ url('users/'~user.id ) }}">{{ user.getFriendlyName() }}</a></p>
                {% else %}
                    <p>{{ comment.name }} ({{ comment.email }})</p>
                {% endif %}

                <hr/>

                <h5>{{ "Element" | t }}</h5>
                {% set element = craft.entries.id(comment.elementId).first() %}
                {% if element %}
                    <p><a class="go" href="{{ element.url }}">{{ element.title }}</a></p>
                {% endif %}

                <hr/>

                <h5>{{ "URL" | t }}</h5>
                <p>{{ comment.url }}</p>

                <h5>{{ "IP Address" | t }}</h5>
                <p>{{ comment.ipAddress }}</p>

                <h5>{{ "User Agent" | t }}</h5>
                <p>{{ comment.userAgent }}</p>

                <hr/>

                <h5>{{ "Created Date" | t }}</h5>
                <p>{{ comment.dateCreated.localeDate() }} {{ comment.dateCreated.localeTime() }}</p>

                <h5>{{ "Updated Date" | t }}</h5>
                <p>{{ comment.dateUpdated.localeDate() }} {{ comment.dateUpdated.localeTime() }}</p>

                {% if currentUser.can('commentsDelete') %}
                    <hr>

                    <input type="button" class="btn small formsubmit" value="Delete" data-action="comments/deleteComment" data-confirm="Are you sure you want to delete this comment?" data-redirect="comments">
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}
